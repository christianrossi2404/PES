

%================= SHAPE FUNCTION DERIVATIVES ======================
%
function dNdxi = shapefunctionderivs_3D(nelnodes,ncoord,elident,xi,n)

  dNdxi = zeros(ncoord*n,nelnodes);
  xi = xi';

if (nelnodes == 4) 
    for i1 = 1:n 
       dNdxi(1,1) = 1.;
       dNdxi(2,2) = 1.;
       dNdxi(3,3) = 1.;
       dNdxi(4,1) = -1.;
       dNdxi(4,2) = -1.;
       dNdxi(4,3) = -1.;
    end
elseif (nelnodes == 8) 
    for i1 = 1:n 
       dNdxi(i1*3-2,1) = -(1.-xi(i1,2))*(1.-xi(i1,3))/8.;
       dNdxi(i1*3-1,1) = -(1.-xi(i1,1))*(1.-xi(i1,3))/8.;
       dNdxi(i1*3,1) = -(1.-xi(i1,1))*(1.-xi(i1,2))/8.;
       dNdxi(i1*3-2,2) = (1.-xi(i1,2))*(1.-xi(i1,3))/8.;
       dNdxi(i1*3-1,2) = -(1.+xi(i1,1))*(1.-xi(i1,3))/8.;
       dNdxi(i1*3,2) = -(1.+xi(i1,1))*(1.-xi(i1,2))/8.;
       dNdxi(i1*3-2,3) = (1.+xi(i1,2))*(1.-xi(i1,3))/8.;
       dNdxi(i1*3-1,3) = (1.+xi(i1,1))*(1.-xi(i1,3))/8.;
       dNdxi(i1*3,3) = -(1.+xi(i1,1))*(1.+xi(i1,2))/8.;
       dNdxi(i1*3-2,4) = -(1.+xi(i1,2))*(1.-xi(i1,3))/8.;
       dNdxi(i1*3-1,4) = (1.-xi(i1,1))*(1.-xi(i1,3))/8.;
       dNdxi(i1*3,4) = -(1.-xi(i1,1))*(1.+xi(i1,2))/8.;
       dNdxi(i1*3-2,5) = -(1.-xi(i1,2))*(1.+xi(i1,3))/8.;
       dNdxi(i1*3-1,5) = -(1.-xi(i1,1))*(1.+xi(i1,3))/8.;
       dNdxi(i1*3,5) = (1.-xi(i1,1))*(1.-xi(i1,2))/8.;
       dNdxi(i1*3-2,6) = (1.-xi(i1,2))*(1.+xi(i1,3))/8.;
       dNdxi(i1*3-1,6) = -(1.+xi(i1,1))*(1.+xi(i1,3))/8.;
       dNdxi(i1*3,6) = (1.+xi(i1,1))*(1.-xi(i1,2))/8.;
       dNdxi(i1*3-2,7) = (1.+xi(i1,2))*(1.+xi(i1,3))/8.;
       dNdxi(i1*3-1,7) = (1.+xi(i1,1))*(1.+xi(i1,3))/8.;
       dNdxi(i1*3,7) = (1.+xi(i1,1))*(1.+xi(i1,2))/8.;
       dNdxi(i1*3-2,8) = -(1.+xi(i1,2))*(1.+xi(i1,3))/8.;
       dNdxi(i1*3-1,8) = (1.-xi(i1,1))*(1.+xi(i1,3))/8.;
       dNdxi(i1*3,8) = (1.-xi(i1,1))*(1.+xi(i1,2))/8.;  
    end
elseif (nelnodes == 10) 
    for i1 = 1:n 
        xi4 = 1.-xi(i1,1)-xi(i1,2)-xi(i1,3);
       dNdxi(3*i1-2,1) = (4.*xi(i1,1)-1.);
       dNdxi(3*i1-1,2) = (4.*xi(i1,2)-1.);
       dNdxi(3*i1,3) = (4.*xi(i1,3)-1.);
       dNdxi(3*i1-2,4) = -(4.*xi4-1.);
       dNdxi(3*i1-1,4) = -(4.*xi4-1.);
       dNdxi(3*i1,4) = -(4.*xi4-1.);
       dNdxi(3*i1-2,5) = 4.*xi(i1,2);
       dNdxi(3*i1-1,5) = 4.*xi(i1,1);
       dNdxi(3*i1-1,6) = 4.*xi(i1,3);
       dNdxi(3*i1,6) = 4.*xi(i1,2);
       dNdxi(3*i1-2,7) = 4.*xi(i1,3);
       dNdxi(3*i1,7) = 4.*xi(i1,1); 
       dNdxi(3*i1-2,8) = 4.*(xi4-xi(i1,1)); %4*(1-2.*xi(i1,1)-xi(i1,21)-xi(i1,3));%modificado 4*x1*(1-x1-x2-x3)
       dNdxi(3*i1-1,8) = -4.*xi(i1,1);
       dNdxi(3*i1,8) = -4.*xi(i1,1);
       dNdxi(3*i1-2,9) = -4.*xi(i1,2);
       dNdxi(3*i1-1,9) = 4*(1-xi(i1,1)-2.*xi(i1,2)-xi(i1,3));%modificado
       dNdxi(3*i1,9) = -4.*xi(i1,2);
       dNdxi(3*i1-2,10) =-4.*xi(i1,3); % 4*(1-xi(i1,1)-xi(i1,2)-2.*xi(i1,3)) ;%modificado
       dNdxi(3*i1-1,10) = -4.*xi(i1,3);
       dNdxi(3*i1,10) = 4.*(xi4-xi(i1,3));
    end
else
    for i1 = 1:n 
       dNdxi(3*i1-2,1) = (-(1.-xi(i1,2))*(1.-xi(i1,3))*(-xi(i1,1)-xi(i1,2)-xi(i1,3)-2.)-(1.-xi(i1,1))*(1.-xi(i1,2))*(1.-xi(i1,3)))/8.;
       dNdxi(3*i1-1,1) = (-(1.-xi(i1,1))*(1.-xi(i1,3))*(-xi(i1,1)-xi(i1,2)-xi(i1,3)-2.)-(1.-xi(i1,1))*(1.-xi(i1,2))*(1.-xi(i1,3)))/8.;
       dNdxi(3*i1,1) = (-(1.-xi(i1,1))*(1.-xi(i1,2))*(-xi(i1,1)-xi(i1,2)-xi(i1,3)-2.)-(1.-xi(i1,1))*(1.-xi(i1,2))*(1.-xi(i1,3)))/8.;

       dNdxi(3*i1-2,2) = ((1.-xi(i1,2))*(1.-xi(i1,3))*(xi(i1,1)-xi(i1,2)-xi(i1,3)-2.)+(1.+xi(i1,1))*(1.-xi(i1,2))*(1.-xi(i1,3)))/8.;
       dNdxi(3*i1-1,2) = (-(1.+xi(i1,1))*(1.-xi(i1,3))*(xi(i1,1)-xi(i1,2)-xi(i1,3)-2.)-(1.+xi(i1,1))*(1.-xi(i1,2))*(1.-xi(i1,3)))/8.;
       dNdxi(3*i1,2) = (-(1.+xi(i1,1))*(1.-xi(i1,2))*(xi(i1,1)-xi(i1,2)-xi(i1,3)-2.)-(1.+xi(i1,1))*(1.-xi(i1,2))*(1.-xi(i1,3)))/8.;

       dNdxi(3*i1-2,3) = ((1.+xi(i1,2))*(1.-xi(i1,3))*(xi(i1,1)+xi(i1,2)-xi(i1,3)-2.)+(1.+xi(i1,1))*(1.+xi(i1,2))*(1.-xi(i1,3)))/8.;
       dNdxi(3*i1-1,3) = ((1.+xi(i1,1))*(1.-xi(i1,3))*(xi(i1,1)+xi(i1,2)-xi(i1,3)-2.)+(1.+xi(i1,1))*(1.+xi(i1,2))*(1.-xi(i1,3)))/8.;
       dNdxi(3*i1,3) = (-(1.+xi(i1,1))*(1.+xi(i1,2))*(xi(i1,1)+xi(i1,2)-xi(i1,3)-2.)-(1.+xi(i1,1))*(1.+xi(i1,2))*(1.-xi(i1,3)))/8.;

       dNdxi(3*i1-2,4) = (-(1.+xi(i1,2))*(1.-xi(i1,3))*(-xi(i1,1)+xi(i1,2)-xi(i1,3)-2.)-(1.-xi(i1,1))*(1.+xi(i1,2))*(1.-xi(i1,3)))/8.;
       dNdxi(3*i1-1,4) = ((1.-xi(i1,1))*(1.-xi(i1,3))*(-xi(i1,1)+xi(i1,2)-xi(i1,3)-2.)+(1.-xi(i1,1))*(1.+xi(i1,2))*(1.-xi(i1,3)))/8.;
       dNdxi(3*i1,4) = (-(1.-xi(i1,1))*(1.+xi(i1,2))*(-xi(i1,1)+xi(i1,2)-xi(i1,3)-2.)-(1.-xi(i1,1))*(1.+xi(i1,2))*(1.-xi(i1,3)))/8.;
       dNdxi(3*i1-2,5) = (-(1.-xi(i1,2))*(1.+xi(i1,3))*(-xi(i1,1)-xi(i1,2)+xi(i1,3)-2.)-(1.-xi(i1,1))*(1.-xi(i1,2))*(1.+xi(i1,3)))/8.;
       dNdxi(3*i1-1,5) = (-(1.-xi(i1,1))*(1.+xi(i1,3))*(-xi(i1,1)-xi(i1,2)+xi(i1,3)-2.)-(1.-xi(i1,1))*(1.-xi(i1,2))*(1.+xi(i1,3)))/8.;
       dNdxi(3*i1,5) = ((1.-xi(i1,1))*(1.-xi(i1,2))*(-xi(i1,1)-xi(i1,2)+xi(i1,3)-2.)+(1.-xi(i1,1))*(1.-xi(i1,2))*(1.+xi(i1,3)))/8.;
       dNdxi(3*i1-2,6) = ((1.-xi(i1,2))*(1.+xi(i1,3))*(xi(i1,1)-xi(i1,2)+xi(i1,3)-2.)+(1.+xi(i1,1))*(1.-xi(i1,2))*(1.+xi(i1,3)))/8.;
       dNdxi(3*i1-1,6) = (-(1.+xi(i1,1))*(1.+xi(i1,3))*(xi(i1,1)-xi(i1,2)+xi(i1,3)-2.)-(1.+xi(i1,1))*(1.-xi(i1,2))*(1.+xi(i1,3)))/8.;
       dNdxi(3*i1,6) = ((1.+xi(i1,1))*(1.-xi(i1,2))*(xi(i1,1)-xi(i1,2)+xi(i1,3)-2.)+(1.+xi(i1,1))*(1.-xi(i1,2))*(1.+xi(i1,3)))/8.;
       dNdxi(3*i1-2,7) = ((1.+xi(i1,2))*(1.+xi(i1,3))*(xi(i1,1)+xi(i1,2)+xi(i1,3)-2.)+(1.+xi(i1,1))*(1.+xi(i1,2))*(1.+xi(i1,3)))/8.;
       dNdxi(3*i1-1,7) = ((1.+xi(i1,1))*(1.+xi(i1,3))*(xi(i1,1)+xi(i1,2)+xi(i1,3)-2.)+(1.+xi(i1,1))*(1.+xi(i1,2))*(1.+xi(i1,3)))/8.;
       dNdxi(3*i1,7) = ((1.+xi(i1,1))*(1.+xi(i1,2))*(xi(i1,1)+xi(i1,2)+xi(i1,3)-2.)+(1.+xi(i1,1))*(1.+xi(i1,2))*(1.+xi(i1,3)))/8.;
       dNdxi(3*i1-2,8) = (-(1.+xi(i1,2))*(1.+xi(i1,3))*(-xi(i1,1)+xi(i1,2)+xi(i1,3)-2.)-(1.-xi(i1,1))*(1.+xi(i1,2))*(1.+xi(i1,3)))/8.;
       dNdxi(3*i1-1,8) = ((1.-xi(i1,1))*(1.+xi(i1,3))*(-xi(i1,1)+xi(i1,2)+xi(i1,3)-2.)+(1.-xi(i1,1))*(1.+xi(i1,2))*(1.+xi(i1,3)))/8.;
       dNdxi(3*i1,8) = ((1.-xi(i1,1))*(1.+xi(i1,2))*(-xi(i1,1)+xi(i1,2)+xi(i1,3)-2.)+(1.-xi(i1,1))*(1.+xi(i1,2))*(1.+xi(i1,3)))/8.;
       dNdxi(3*i1-2,9)  = -2.*xi(i1,1)*(1.-xi(i1,2))*(1.-xi(i1,3))/4.;
       dNdxi(3*i1-1,9)  = -(1.-xi(i1,1)^2)*(1.-xi(i1,3))/4.;
       dNdxi(3*i1,9)  = -(1.-xi(i1,1)^2)*(1.-xi(i1,2))/4.;
       dNdxi(3*i1-2,10)  = (1.-xi(i1,2)^2)*(1.-xi(i1,3))/4.;
       dNdxi(3*i1-1,10)  = -2.*xi(i1,2)*(1.+xi(i1,1))*(1.-xi(i1,3))/4.;
       dNdxi(3*i1,10)  = -(1.-xi(i1,2)^2)*(1.+xi(i1,1))/4.;
       dNdxi(3*i1-2,11)  = -2.*xi(i1,1)*(1.+xi(i1,2))*(1.-xi(i1,3))/4.;
       dNdxi(3*i1-1,11)  = (1.-xi(i1,1)^2)*(1.-xi(i1,3))/4.;
       dNdxi(3*i1,11)  = -(1.-xi(i1,1)^2)*(1.+xi(i1,2))/4.;
       dNdxi(3*i1-2,12)  = -(1.-xi(i1,2)^2)*(1.-xi(i1,3))/4.;
       dNdxi(3*i1-1,12)  = -2.*xi(i1,2)*(1.-xi(i1,1))*(1.-xi(i1,3))/4.;
       dNdxi(3*i1,12)  = -(1.-xi(i1,2)^2)*(1.-xi(i1,1))/4.;
       dNdxi(3*i1-2,13)  = -2.*xi(i1,1)*(1.-xi(i1,2))*(1.+xi(i1,3))/4.;
       dNdxi(3*i1-1,13)  = -(1.-xi(i1,1)^2)*(1.+xi(i1,3))/4.;
       dNdxi(3*i1,13)  = (1.-xi(i1,1)^2)*(1.-xi(i1,2))/4.;
       dNdxi(3*i1-2,14)  = (1.-xi(i1,2)^2)*(1.+xi(i1,3))/4.;
       dNdxi(3*i1-1,14)  = -2.*xi(i1,2)*(1.+xi(i1,1))*(1.+xi(i1,3))/4.;
       dNdxi(3*i1,14)  = (1.-xi(i1,2)^2)*(1.+xi(i1,1))/4.;
       dNdxi(3*i1-2,15)  = -2.*xi(i1,1)*(1.+xi(i1,2))*(1.+xi(i1,3))/4.;
       dNdxi(3*i1-1,15)  =  (1.-xi(i1,1)^2)*(1.+xi(i1,3))/4.;
       dNdxi(3*i1,15)  = (1.-xi(i1,1)^2)*(1.+xi(i1,2))/4.;
       dNdxi(3*i1-2,16)  = -(1.-xi(i1,2)^2)*(1.+xi(i1,3))/4.;
       dNdxi(3*i1-1,16)  = -2.*xi(i1,2)*(1.-xi(i1,1))*(1.+xi(i1,3))/4.;
       dNdxi(3*i1,16)  = (1.-xi(i1,2)^2)*(1.-xi(i1,1))/4.;
       dNdxi(3*i1-2,17) = -(1.-xi(i1,2))*(1.-xi(i1,3)^2)/4.;
       dNdxi(3*i1-1,17) = -(1.-xi(i1,1))*(1.-xi(i1,3)^2)/4.;
       dNdxi(3*i1,17) = -xi(i1,3)*(1.-xi(i1,1))*(1.-xi(i1,2))/2.;
       dNdxi(3*i1-2,18) = (1.-xi(i1,2))*(1.-xi(i1,3)^2)/4.;
       dNdxi(3*i1-1,18) = -(1.+xi(i1,1))*(1.-xi(i1,3)^2)/4.;
       dNdxi(3*i1,18) = -xi(i1,3)*(1.+xi(i1,1))*(1.-xi(i1,2))/2.;
       dNdxi(3*i1-2,19) = (1.+xi(i1,2))*(1.-xi(i1,3)^2)/4.;
       dNdxi(3*i1-1,19) = (1.+xi(i1,1))*(1.-xi(i1,3)^2)/4.;
       dNdxi(3*i1,19) = -xi(i1,3)*(1.+xi(i1,1))*(1.+xi(i1,2))/2.;
       dNdxi(3*i1-2,20) = -(1.+xi(i1,2))*(1.-xi(i1,3)^2)/4.;
       dNdxi(3*i1-1,20) = (1.-xi(i1,1))*(1.-xi(i1,3)^2)/4.;
       dNdxi(3*i1,20) = -xi(i1,3)*(1.-xi(i1,1))*(1.+xi(i1,2))/2.;    
    end    
end


